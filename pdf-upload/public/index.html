<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PK CRM - PDF Upload & Processing</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-file-pdf"></i>
                    <h1>PK CRM PDF Processor</h1>
                </div>
                <div class="status-indicator" id="connectionStatus">
                    <div class="status-dot"></div>
                    <span>ระบบพร้อมใช้งาน</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-card">
                    <div class="upload-header">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h2>อัพโหลด PDF สำหรับประมวลผล</h2>
                        <p>รองรับไฟล์ใบเสนอราคา และใบสั่งขาย (PDF เท่านั้น, ขนาดไม่เกิน 10MB)</p>
                    </div>

                    <div class="upload-area" id="uploadArea">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="upload-zone" id="uploadZone">
                                <i class="fas fa-file-upload upload-icon"></i>
                                <p class="upload-text">ลากไฟล์ PDF มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</p>
                                <input type="file" id="fileInput" name="pdf" accept=".pdf" hidden>
                                <button type="button" class="browse-btn" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open"></i> เลือกไฟล์
                                </button>
                            </div>
                            
                            <div class="file-info" id="fileInfo" style="display: none;">
                                <div class="file-preview">
                                    <i class="fas fa-file-pdf file-icon"></i>
                                    <div class="file-details">
                                        <div class="file-name" id="fileName"></div>
                                        <div class="file-size" id="fileSize"></div>
                                    </div>
                                    <button type="button" class="remove-file" id="removeFile">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <button type="submit" class="upload-submit" id="uploadSubmit" disabled>
                                <i class="fas fa-upload"></i>
                                <span>เริ่มประมวลผล PDF</span>
                            </button>
                        </form>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">กำลังอัพโหลด...</div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="results-card">
                    <div class="results-header">
                        <i class="fas fa-check-circle success-icon"></i>
                        <h3>ผลการประมวลผล</h3>
                    </div>
                    <div class="results-content" id="resultsContent">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Upload History -->
            <div class="history-section">
                <div class="history-card">
                    <div class="history-header">
                        <i class="fas fa-history"></i>
                        <h3>ประวัติการอัพโหลด</h3>
                        <button class="refresh-btn" id="refreshHistory">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="history-content" id="historyContent">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>กำลังโหลดข้อมูล...</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-cog fa-spin"></i>
            </div>
            <div class="loading-text">กำลังประมวลผล PDF...</div>
            <div class="loading-steps">
                <div class="step active" id="step1">
                    <i class="fas fa-upload"></i> อัพโหลดไฟล์
                </div>
                <div class="step" id="step2">
                    <i class="fas fa-search"></i> แยกข้อมูล
                </div>
                <div class="step" id="step3">
                    <i class="fas fa-database"></i> บันทึกลงฐานข้อมูล
                </div>
                <div class="step" id="step4">
                    <i class="fas fa-check"></i> เสร็จสิ้น
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let selectedFile = null;
        let isUploading = false;

        // DOM elements
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadZone = document.getElementById('uploadZone');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadSubmit = document.getElementById('uploadSubmit');
        const removeFile = document.getElementById('removeFile');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');
        const historyContent = document.getElementById('historyContent');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const refreshHistory = document.getElementById('refreshHistory');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadUploadHistory();
            checkServerStatus();
        });

        function setupEventListeners() {
            // File input change
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('drop', handleDrop);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            
            // Form submit
            uploadForm.addEventListener('submit', handleFormSubmit);
            
            // Remove file
            removeFile.addEventListener('click', clearFileSelection);
            
            // Refresh history
            refreshHistory.addEventListener('click', loadUploadHistory);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                validateAndDisplayFile(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadZone.classList.add('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadZone.classList.remove('drag-over');
            
            const file = event.dataTransfer.files[0];
            if (file) {
                fileInput.files = event.dataTransfer.files;
                validateAndDisplayFile(file);
            }
        }

        function handleDragLeave(event) {
            uploadZone.classList.remove('drag-over');
        }

        function validateAndDisplayFile(file) {
            // Validate file type
            if (file.type !== 'application/pdf') {
                showAlert('error', 'กรุณาเลือกไฟล์ PDF เท่านั้น');
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showAlert('error', 'ขนาดไฟล์ใหญ่เกินไป (สูงสุด 10MB)');
                return;
            }

            selectedFile = file;
            displayFileInfo(file);
        }

        function displayFileInfo(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            uploadZone.style.display = 'none';
            fileInfo.style.display = 'block';
            uploadSubmit.disabled = false;
        }

        function clearFileSelection() {
            selectedFile = null;
            fileInput.value = '';
            uploadZone.style.display = 'block';
            fileInfo.style.display = 'none';
            uploadSubmit.disabled = true;
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!selectedFile || isUploading) {
                return;
            }

            uploadFile();
        }

        async function uploadFile() {
            isUploading = true;
            showLoadingOverlay();
            updateLoadingStep(1);

            const formData = new FormData();
            formData.append('pdf', selectedFile);

            try {
                updateLoadingStep(2);
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                updateLoadingStep(3);

                const result = await response.json();

                if (result.success) {
                    updateLoadingStep(4);
                    setTimeout(() => {
                        hideLoadingOverlay();
                        displayResults(result.data);
                        clearFileSelection();
                        loadUploadHistory();
                        showAlert('success', 'ประมวลผล PDF สำเร็จ!');
                    }, 1000);
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                hideLoadingOverlay();
                showAlert('error', 'เกิดข้อผิดพลาด: ' + error.message);
                console.error('Upload error:', error);
            } finally {
                isUploading = false;
            }
        }

        function displayResults(data) {
            const html = `
                <div class="result-item">
                    <div class="result-label">ประเภทเอกสาร:</div>
                    <div class="result-value">${getDocumentTypeText(data.parsedData.type)}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">ชื่อไฟล์:</div>
                    <div class="result-value">${data.originalName}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">ขนาดไฟล์:</div>
                    <div class="result-value">${formatFileSize(data.size)}</div>
                </div>
                ${data.parsedData.quotationNumber ? `
                <div class="result-item">
                    <div class="result-label">เลขที่เอกสาร:</div>
                    <div class="result-value">${data.parsedData.quotationNumber}</div>
                </div>
                ` : ''}
                ${data.parsedData.customerName ? `
                <div class="result-item">
                    <div class="result-label">ชื่อลูกค้า:</div>
                    <div class="result-value">${data.parsedData.customerName}</div>
                </div>
                ` : ''}
                ${data.parsedData.total ? `
                <div class="result-item">
                    <div class="result-label">ยอดรวม:</div>
                    <div class="result-value">${data.parsedData.total.toLocaleString()} บาท</div>
                </div>
                ` : ''}
                <div class="result-item">
                    <div class="result-label">เวลาประมวลผล:</div>
                    <div class="result-value">${new Date(data.uploadTime).toLocaleString('th-TH')}</div>
                </div>
                <div class="result-actions">
                    <button class="btn-secondary" onclick="viewExtractedText('${data.fileId}')">
                        <i class="fas fa-eye"></i> ดูข้อความที่แยกได้
                    </button>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';
        }

        async function loadUploadHistory() {
            try {
                historyContent.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>กำลังโหลด...</span></div>';
                
                const response = await fetch('/uploads');
                const result = await response.json();

                if (result.success) {
                    displayUploadHistory(result.uploads);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                historyContent.innerHTML = '<div class="error-message">ไม่สามารถโหลดประวัติได้</div>';
                console.error('History load error:', error);
            }
        }

        function displayUploadHistory(uploads) {
            if (uploads.length === 0) {
                historyContent.innerHTML = '<div class="empty-message">ยังไม่มีประวัติการอัพโหลด</div>';
                return;
            }

            const html = uploads.map(upload => `
                <div class="history-item">
                    <div class="history-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="history-details">
                        <div class="history-name">${upload.original_filename}</div>
                        <div class="history-meta">
                            ${formatFileSize(upload.file_size)} • 
                            ${new Date(upload.created_at).toLocaleString('th-TH')}
                        </div>
                    </div>
                    <div class="history-actions">
                        <button class="btn-icon" onclick="viewUploadDetails(${upload.attachment_id})" title="ดูรายละเอียด">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            historyContent.innerHTML = html;
        }

        function showLoadingOverlay() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            loadingOverlay.style.display = 'none';
            // Reset all steps
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
        }

        function updateLoadingStep(stepNumber) {
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index < stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('/health');
                const result = await response.json();
                
                if (result.status === 'OK') {
                    updateConnectionStatus(true, 'ระบบพร้อมใช้งาน');
                } else {
                    updateConnectionStatus(false, 'ระบบมีปัญหา');
                }
            } catch (error) {
                updateConnectionStatus(false, 'ไม่สามารถเชื่อมต่อได้');
            }
        }

        function updateConnectionStatus(isConnected, message) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusDot = statusIndicator.querySelector('.status-dot');
            const statusText = statusIndicator.querySelector('span');
            
            statusDot.className = `status-dot ${isConnected ? 'connected' : 'disconnected'}`;
            statusText.textContent = message;
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getDocumentTypeText(type) {
            const types = {
                'quotation': 'ใบเสนอราคา',
                'sales_order': 'ใบสั่งขาย',
                'unknown': 'ไม่ระบุ'
            };
            return types[type] || 'ไม่ระบุ';
        }

        function showAlert(type, message) {
            // Simple alert - can be enhanced with custom modal
            const icon = type === 'success' ? '✅' : '❌';
            alert(`${icon} ${message}`);
        }

        // Placeholder functions for future implementation
        function viewExtractedText(fileId) {
            alert('ฟีเจอร์นี้จะพัฒนาในขั้นตอนถัดไป');
        }

        function viewUploadDetails(attachmentId) {
            alert('ฟีเจอร์นี้จะพัฒนาในขั้นตอนถัดไป');
        }
    </script>
</body>
</html>
